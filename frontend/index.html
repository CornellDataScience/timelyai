<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimelyAI</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1 class="title">üï∞Ô∏è TimelyAI</h1>

        <!-- Todo List -->
        <div class="section">
            <h2>Todo List:</h2>
            <!-- will be populated from Firestore -->
            <ul id="taskList">
                <li>Loading tasks‚Ä¶</li>
            </ul>
            <button id="showTaskForm">+ Add New Task</button>
        </div>

        <!-- Schedule Event Form -->
        <div class="section">
            <h2>Schedule Event</h2>
            <input type="text" id="eventTitle" placeholder="Title...">
            <input type="date" id="eventDate">
            <input type="time" id="eventTime">
            <input type="text" id="eventLocation" placeholder="Enter the Location">
            <button id="createEvent">+ Create Event</button>
        </div>

        <!-- Your Events (from Firestore) -->
        <div class="section">
            <h2>Your Events:</h2>
            <ul id="eventList">
                <li>Loading events‚Ä¶</li>
            </ul>
        </div>

        <!-- Weekly Breakdown Pie Chart -->
        <div class="section">
            <div class="svg-pie-container">
                <h2>Weekly Breakup:</h2>
                <svg id="perfectPie" width="300" height="300" viewBox="0 0 300 300"></svg>
                <div class="legend">
                    <div><span class="color-box school"></span> School</div>
                    <div><span class="color-box clubs"></span> Clubs</div>
                    <div><span class="color-box friends"></span> Friends</div>
                    <div><span class="color-box hobbies"></span> Hobbies</div>
                    <div><span class="color-box other"></span> Other</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal (unchanged) -->
    <div id="taskModal" class="modal">
      <!-- ‚Ä¶ -->
    </div>

    <!-- Firebase & App logic -->
    <script type="module">
    // 1) load Firebase via CDN
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore,
      doc,
      onSnapshot,
      getDoc,
      collection,
      addDoc
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // 2) existing config
    const firebaseConfig = {
      apiKey: "AIzaSyCvY1agnqbLx7wf4HXPL85TLpzNEdNQ",
      authDomain: "timelyai-ff137.firebaseapp.com",
      projectId: "timelyai-ff137",
      storageBucket: "timelyai-ff137.firebasestorage.app",
      messagingSenderId: "845744253750",
      appId: "1:845744253750:web:66b79658d16d211ef32197",
      measurementId: "G-DDEFL10MJT"
    };

    // 3) init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 4) pick a userId 
    const userId = 'TestALL2';

    // 5) Real-time subscribe tasks
    const taskListEl = document.getElementById('taskList');
    const tasksDocRef = doc(db, 'UserTasks', userId);
    onSnapshot(tasksDocRef, snap => {
      taskListEl.innerHTML = '';
      if (!snap.exists() || !snap.data().tasks) {
        taskListEl.innerHTML = '<li>No tasks yet.</li>';
        return;
      }
      const tasks = snap.data().tasks;
      for (const [id, t] of Object.entries(tasks)) {
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>${t.taskName}</strong>
          <span>Due: ${t.taskDeadline} | Duration: ${t.taskDuration} hrs | Category: ${t.taskCategory}</span>
        `;
        taskListEl.appendChild(li);
      }
    });

    // 6) Real-time subscribe events
    const eventListEl = document.getElementById('eventList');
    const eventsDocRef = doc(db, 'UserCalendars', userId);
    onSnapshot(eventsDocRef, snap => {
      eventListEl.innerHTML = '';
      if (!snap.exists() || !snap.data().events) {
        eventListEl.innerHTML = '<li>No events found.</li>';
        return;
      }
      const evs = snap.data().events;
      for (const [eid, e] of Object.entries(evs)) {
        const li = document.createElement('li');
        // Keys "summary", "start_time", "location"
        li.innerHTML = `
          <strong>${e.summary || e.title}</strong>
          <span>${e.start_time ? new Date(e.start_time).toLocaleString() : ''}</span>
          <span>${e.location || ''}</span>
        `;
        eventListEl.appendChild(li);
      }
    });

    // 7) wire create event button to add a new event
    document.getElementById('createEvent').addEventListener('click', async () => {
      const title = document.getElementById('eventTitle').value;
      const date = document.getElementById('eventDate').value;
      const time = document.getElementById('eventTime').value;
      const location = document.getElementById('eventLocation').value;
      if (!title || !date || !time) return alert('Title, date, and time required');
      // write into the ‚Äúevents‚Äù map atomically
      const docRef = doc(db, 'UserCalendars', userId);
      const newEvent = {
        generatedAt: Date.now(),
        summary: title,
        start_time: `${date}T${time}:00`,
        location
      };
      // Firestore doesn‚Äôt let us merge into nested maps by keypath easily from the web SDK,
      // so we just read-modify-write here:
      const snap = await getDoc(docRef);
      const all = snap.exists() && snap.data().events ? snap.data().events : {};
      const newId = crypto.randomUUID();
      all[newId] = newEvent;
      await await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js')
        .then(({ setDoc }) => setDoc(docRef, { events: all }, { merge: true }));
    });
    </script>

    <!-- existing scripts -->
    <script src="perfectPieChart.js"></script>
</body>
</html>
